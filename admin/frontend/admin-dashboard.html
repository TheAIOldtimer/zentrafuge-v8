// Enhanced metrics schema for Zentrafuge emotional intelligence
const EmotionalMetricsSchema = new mongoose.Schema({
  // Traditional metrics
  activeUsers: Number,
  apiCalls: Number,
  responseTime: Number,
  
  // Zentrafuge-specific emotional metrics
  emotionalHealth: {
    averageSessionDepth: Number, // How vulnerable users become
    crisisInterventions: Number, // Safety escalations per day
    healingProgressions: Number, // Users showing emotional growth
    trustDepthScores: Number,    // Average relationship depth with Cael
  },
  
  // User wellbeing indicators (anonymized)
  userWellbeing: {
    returningUserRate: Number,    // Users coming back after difficult sessions
    emotionalRegulationGains: Number, // Users reporting feeling better
    communityConnections: Number, // Anonymous solidarity features used
  },
  
  // System emotional intelligence
  caelPerformance: {
    emotionMatchAccuracy: Number, // How well Cael reads emotional state
    memoryRelevanceScore: Number, // How often recalled memories help
    safetyProtocolTriggers: Number, // Times safety protocols activated
  },
  
  timestamp: { type: Date, default: Date.now },
});

// Enhanced suggestions system - emotionally aware
const generateZentrafugeSuggestions = async () => {
  const metrics = await EmotionalMetrics.findOne().sort({ timestamp: -1 });
  const suggestions = [];
  
  // Emotional intelligence suggestions
  if (metrics?.caelPerformance?.emotionMatchAccuracy < 0.8) {
    suggestions.push({
      type: 'emotional_intelligence',
      priority: 'high',
      message: 'Cael\'s emotion recognition needs calibration - users may feel misunderstood',
      action: 'Review emotion_parser.py training data'
    });
  }
  
  // Safety protocol suggestions
  if (metrics?.emotionalHealth?.crisisInterventions > 5) {
    suggestions.push({
      type: 'safety',
      priority: 'urgent',
      message: 'Higher crisis interventions detected - review safety protocols',
      action: 'Check crisis_intervention.py and local resource database'
    });
  }
  
  // Healing effectiveness suggestions
  if (metrics?.userWellbeing?.emotionalRegulationGains < 0.6) {
    suggestions.push({
      type: 'effectiveness',
      priority: 'medium',
      message: 'Users report lower emotional regulation gains this week',
      action: 'Review orchestrator.py emotional strategy logic'
    });
  }
  
  // Memory system suggestions
  if (metrics?.caelPerformance?.memoryRelevanceScore < 0.7) {
    suggestions.push({
      type: 'memory',
      priority: 'medium',
      message: 'Memory recalls feel less relevant - may need tuning',
      action: 'Review memory_engine.py recall algorithms'
    });
  }
  
  return suggestions;
};

// Enhanced dashboard data endpoint
app.get('/api/admin/dashboard', authenticateAdmin, async (req, res) => {
  try {
    const metrics = await EmotionalMetrics.findOne().sort({ timestamp: -1 });
    const suggestions = await generateZentrafugeSuggestions();
    
    // Privacy-safe user insights
    const userInsights = {
      totalUsers: await User.countDocuments(),
      activeToday: await getActiveUsersToday(),
      vulnerabilityDistribution: await getAnonymizedVulnerabilityStats(),
      healingProgression: await getHealingProgressionStats(),
    };
    
    res.json({ 
      metrics: metrics || {}, 
      suggestions,
      userInsights,
      systemHealth: await getSystemHealthStatus()
    });
  } catch (err) {
    res.status(500).json({ message: 'Server error' });
  }
});

// Privacy-preserving analytics functions
const getAnonymizedVulnerabilityStats = async () => {
  // Return distribution of emotional depth without personal data
  return {
    surfaceLevel: 45,  // % of users sharing at surface level
    moderate: 35,      // % sharing moderately personal info
    deep: 20          // % sharing deeply vulnerable content
  };
};

const getHealingProgressionStats = async () => {
  // Track emotional growth patterns anonymously
  return {
    newUsers: 30,           // Users in first 2 weeks
    buildingTrust: 45,      // Users 2-8 weeks, trust building
    deepConnection: 25      // Users 8+ weeks, strong bond with Cael
  };
};

const getSystemHealthStatus = async () => {
  return {
    caelEmotionalIQ: 'healthy',     // Overall emotional intelligence
    memorySystem: 'optimal',        // Memory recall effectiveness  
    safetyProtocols: 'active',      // Crisis intervention readiness
    userTrust: 'growing',           // Trust metrics trending
  };
};
