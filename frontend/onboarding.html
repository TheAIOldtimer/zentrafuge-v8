<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zentrafuge Onboarding – Meet Cael</title>
    <link rel="icon" href="Zentrafuge-WIDE-Logo-Transparent.png">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f7faff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            min-height: 100vh;
        }

        .top-language-bar {
            width: 100%;
            background: linear-gradient(135deg, #003366 0%, #0055aa 100%);
            color: white;
            padding: 0.6rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .language-dropdown-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .language-dropdown {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
        }

        .language-dropdown:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .language-dropdown-arrow {
            margin-left: auto;
            transform: rotate(0deg);
            transition: transform 0.2s ease;
        }

        .language-dropdown.open .language-dropdown-arrow {
            transform: rotate(180deg);
        }

        .language-options-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }

        .language-options-dropdown.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .language-option-dropdown {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            color: #333;
            font-size: 0.85rem;
        }

        .language-option-dropdown:last-child {
            border-bottom: none;
        }

        .language-option-dropdown:hover {
            background: #f8f9ff;
        }

        .language-option-dropdown.selected {
            background: #eef2ff;
            color: #0055aa;
            font-weight: 500;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(247, 250, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-spinner-large {
            width: 40px;
            height: 40px;
            border: 4px solid #ddd;
            border-top: 4px solid #0055aa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        header {
            text-align: center;
            padding: 2rem 1rem 1rem;
        }

        header img {
            max-width: 240px;
        }

        .header-fallback {
            font-size: 2rem;
            color: #003366;
            font-weight: bold;
        }

        .onboarding-container {
            width: 100%;
            max-width: 720px;
            margin: 0 1rem;
        }

        .onboarding-box {
            background: white;
            padding: 2rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .onboarding-box.hidden {
            display: none;
        }

        .onboarding-box h2 {
            margin-top: 0;
            font-size: 1.4rem;
            color: #003366;
        }

        .cael-intro {
            background: linear-gradient(135deg, #eef2ff 0%, #e6f3ff 100%);
            border-left: 4px solid #0055aa;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            font-style: italic;
            color: #333;
        }

        .question-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .question-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .theme-header {
            font-size: 0.9rem;
            color: #0055aa;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .question-label {
            display: block;
            margin: 0.5rem 0;
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
        }

        .question-context {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .onboarding-box textarea,
        .onboarding-box input[type="text"],
        .onboarding-box select {
            width: 100%;
            padding: 0.8rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .onboarding-box textarea:focus,
        .onboarding-box input[type="text"]:focus,
        .onboarding-box select:focus {
            outline: none;
            border-color: #0055aa;
            box-shadow: 0 0 0 2px rgba(0, 85, 170, 0.1);
        }

        .multi-choice {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.8rem;
            margin-top: 0.8rem;
        }

        .multi-choice-item {
            position: relative;
        }

        .multi-choice input[type="radio"],
        .multi-choice input[type="checkbox"] {
            display: none;
        }

        .multi-choice label {
            display: block;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            user-select: none;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            font-weight: normal;
        }

        .multi-choice label:hover {
            background: #eef2ff;
            border-color: #cce4ff;
        }

        .multi-choice input:checked + label {
            background: #cce4ff;
            border-color: #0055aa;
            color: #003366;
            font-weight: 500;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #f0f0f0;
        }

        .btn {
            padding: 0.8rem 1.6rem;
            font-size: 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            position: relative;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #003366;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0055aa;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            color: #333;
        }

        .loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            margin: 0 5px;
            transition: background 0.2s ease;
        }

        .progress-dot.active {
            background: #0055aa;
        }

        .progress-dot.completed {
            background: #28a745;
        }

        .skip-note {
            font-size: 0.85rem;
            color: #999;
            text-align: center;
            margin-top: 1rem;
        }

        .status-message {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .status-message.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .status-message.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .auth-notice {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .auth-notice a {
            color: #721c24;
            text-decoration: underline;
            font-weight: bold;
        }

        footer {
            text-align: center;
            font-size: 0.85rem;
            padding: 2rem 1rem;
            color: #777;
            margin-top: auto;
        }

        @media (max-width: 600px) {
            .top-language-bar {
                padding: 0.8rem;
            }

            .onboarding-box {
                padding: 1.5rem;
                margin: 0.5rem;
            }
            
            .multi-choice {
                grid-template-columns: 1fr;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 1rem;
            }

            .language-dropdown-container {
                width: 100%;
                justify-content: center;
            }

            header img {
                max-width: 180px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner-large"></div>
    </div>

    <!-- Top Language Selector Bar -->
    <div class="top-language-bar">
        <div class="language-dropdown-container">
            <div class="language-dropdown" onclick="toggleLanguageDropdown()">
                <span class="language-flag" id="selected-flag">🌍</span>
                <span class="language-name" id="selected-language">Loading...</span>
                <span class="language-dropdown-arrow">▼</span>
            </div>
            <div class="language-options-dropdown" id="language-dropdown">
                <!-- Language options populated by JavaScript -->
            </div>
        </div>
    </div>

    <header>
        <img src="Zentrafuge-WIDE-Logo-Transparent.png" alt="Zentrafuge Logo" onerror="this.style.display='none'; document.querySelector('.header-fallback').style.display='block';" />
        <div class="header-fallback" style="display: none;">Zentrafuge</div>
    </header>

    <div class="onboarding-container">
        <div class="auth-notice" id="auth-notice">
            <span data-translate="authNotice">Loading...</span> <a href="index.html" data-translate="loginLink">Log in</a>
        </div>
        
        <div class="status-message" id="status-message"></div>
        
        <div class="progress-indicator">
            <div class="progress-dot active" data-step="0"></div>
            <div class="progress-dot" data-step="1"></div>
            <div class="progress-dot" data-step="2"></div>
            <div class="progress-dot" data-step="3"></div>
            <div class="progress-dot" data-step="4"></div>
        </div>

        <!-- Welcome Screen -->
        <div class="onboarding-box" id="step-0">
            <h2 data-translate="welcomeTitle">Loading...</h2>
            <div class="cael-intro" data-translate="caelIntro">
                Loading...
            </div>
            <p data-translate="welcomeDescription">Loading...</p>
            <div class="navigation-buttons">
                <div></div>
                <button class="btn btn-primary" id="begin-button" onclick="handleNextStep()" disabled data-translate="beginButton">Loading...</button>
            </div>
        </div>

        <!-- Step 1: Safety & Boundaries -->
        <div class="onboarding-box hidden" id="step-1">
            <div class="theme-header" data-translate="safetyHeader">Loading...</div>
            
            <div class="question-section">
                <label class="question-label" data-translate="communicationQuestion">Loading...</label>
                <div class="question-context" data-translate="communicationContext">Loading...</div>
                <div class="multi-choice">
                    <div class="multi-choice-item">
                        <input type="radio" id="heard-direct" name="communication_style" value="direct_feedback" />
                        <label for="heard-direct" data-translate="directLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="radio" id="heard-gentle" name="communication_style" value="gentle_exploration" />
                        <label for="heard-gentle" data-translate="gentleLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="radio" id="heard-witness" name="communication_style" value="just_witnessing" />
                        <label for="heard-witness" data-translate="witnessLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="radio" id="heard-mix" name="communication_style" value="mix_depends" />
                        <label for="heard-mix" data-translate="mixLabel">Loading...</label>
                    </div>
                </div>
            </div>

            <div class="question-section">
                <label class="question-label" data-translate="processingQuestion">Loading...</label>
                <div class="question-context" data-translate="processingContext">Loading...</div>
                <div class="multi-choice">
                    <div class="multi-choice-item">
                        <input type="radio" id="process-deep" name="emotional_pacing" value="dive_deep_quickly" />
                        <label for="process-deep" data-translate="deepLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="radio" id="process-gradual" name="emotional_pacing" value="circle_gradually" />
                        <label for="process-gradual" data-translate="gradualLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="radio" id="process-varies" name="emotional_pacing" value="varies_situation" />
                        <label for="process-varies" data-translate="variesLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="radio" id="process-unsure" name="emotional_pacing" value="not_sure_yet" />
                        <label for="process-unsure" data-translate="unsureLabel">Loading...</label>
                    </div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="handlePrevStep()" data-translate="backButton">Loading...</button>
                <button class="btn btn-primary" onclick="handleNextStep()" data-translate="continueButton">Loading...</button>
            </div>
        </div>

        <!-- Step 2: Identity & Purpose -->
        <div class="onboarding-box hidden" id="step-2">
            <div class="theme-header" data-translate="identityHeader">Loading...</div>
            
            <div class="question-section">
                <label class="question-label" data-translate="lifeChapterQuestion">Loading...</label>
                <div class="question-context" data-translate="lifeChapterContext">Loading...</div>
                <input type="text" id="life_chapter" name="life_chapter" data-translate-placeholder="lifeChapterPlaceholder" />
            </div>

            <div class="question-section">
                <label class="question-label" data-translate="meaningQuestion">Loading...</label>
                <div class="question-context" data-translate="meaningContext">Loading...</div>
                <div class="multi-choice">
                    <div class="multi-choice-item">
                        <input type="checkbox" id="meaning-creative" name="sources_of_meaning" value="creative_work" />
                        <label for="meaning-creative" data-translate="creativeLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="checkbox" id="meaning-helping" name="sources_of_meaning" value="helping_others" />
                        <label for="meaning-helping" data-translate="helpingLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="checkbox" id="meaning-nature" name="sources_of_meaning" value="being_in_nature" />
                        <label for="meaning-nature" data-translate="natureLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="checkbox" id="meaning-learning" name="sources_of_meaning" value="learning_growing" />
                        <label for="meaning-learning" data-translate="learningLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="checkbox" id="meaning-connection" name="sources_of_meaning" value="deep_connections" />
                        <label for="meaning-connection" data-translate="connectionLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="checkbox" id="meaning-other" name="sources_of_meaning" value="something_else" />
                        <label for="meaning-other" data-translate="otherLabel">Loading...</label>
                    </div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="handlePrevStep()" data-translate="backButton">Loading...</button>
                <button class="btn btn-primary" onclick="handleNextStep()" data-translate="continueButton">Loading...</button>
            </div>
        </div>

        <!-- Step 3: Support Style -->
        <div class="onboarding-box hidden" id="step-3">
            <div class="theme-header" data-translate="supportHeader">Loading...</div>
            
            <div class="question-section">
                <label class="question-label" data-translate="supportQuestion">Loading...</label>
                <div class="question-context" data-translate="supportContext">Loading...</div>
                <div class="multi-choice">
                    <div class="multi-choice-item">
                        <input type="checkbox" id="support-listening" name="effective_support" value="deep_listening" />
                        <label for="support-listening" data-translate="listeningLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="checkbox" id="support-practical" name="effective_support" value="practical_solutions" />
                        <label for="support-practical" data-translate="practicalLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="checkbox" id="support-challenge" name="effective_support" value="gentle_challenges" />
                        <label for="support-challenge" data-translate="challengeLabel">Loading...</label>
                    </div>
                    <div class="multi-choice-item">
                        <input type="checkbox" id="support-presence" name="effective_support" value="just_presence" />
                        <label for="support-presence" data-translate="presenceLabel">Loading...</label>
                    </div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="handlePrevStep()" data-translate="backButton">Loading...</button>
                <button class="btn btn-primary" onclick="handleNextStep()" data-translate="continueButton">Loading...</button>
            </div>
        </div>

        <!-- Step 4: Final Questions -->
        <div class="onboarding-box hidden" id="step-4">
            <div class="theme-header" data-translate="finalHeader">Loading...</div>
            
            <div class="question-section">
                <label class="question-label" data-translate="nameQuestion">Loading...</label>
                <div class="question-context" data-translate="nameContext">Loading...</div>
                <input type="text" id="ai_name" name="ai_name" value="Cael" />
            </div>

            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="handlePrevStep()" data-translate="backButton">Loading...</button>
                <button class="btn btn-primary" id="complete-button" onclick="handleCompleteOnboarding()">
                    <span data-translate="completeButton">Loading...</span>
                    <span class="loading-spinner"></span>
                </button>
            </div>
        </div>
    </div>

    <div class="skip-note" data-translate="skipNote">Loading...</div>

    <footer data-translate="footerText">Loading...</footer>

    <!-- Firebase SDKs -->
    <!-- CORRECT script loading order -->

<!-- 1. Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

<!-- 2. Firebase Configuration -->
<script src="firebases-init.js"></script>

<!-- 3. Debug script (TEMPORARY) -->
<script>
console.log('🔍 DEBUG: Starting authentication debug...');

if (typeof firebase === 'undefined') {
    console.error('❌ Firebase not loaded');
} else {
    console.log('✅ Firebase loaded');
}

// Track auth listener registrations
let listenerCount = 0;
const originalOnAuthStateChanged = firebase.auth().onAuthStateChanged;
firebase.auth().onAuthStateChanged = function(...args) {
    listenerCount++;
    console.warn(`🚨 Auth listener #${listenerCount} being registered!`);
    if (listenerCount > 1) {
        console.error('❌ MULTIPLE AUTH LISTENERS DETECTED - THIS CAUSES THE LOOP!');
        console.trace('Multiple listener trace:');
    }
    return originalOnAuthStateChanged.apply(this, args);
};
</script>

<!-- 4. Military knowledge scripts -->
<script src="utils/military_knowledge/uk_military_data.js"></script>
<script src="utils/military_knowledge/us_military_data.js"></script>
<script src="utils/military_knowledge/ca_military_data.js"></script>
<script src="utils/military_knowledge/au_military_data.js"></script>
<script src="utils/military_knowledge/nz_military_data.js"></script>

<!-- 5. Your modular scripts -->
<script type="module" src="js/auth.js"></script>
<script type="module" src="js/main.js"></script>

    <script>
        class ZentrafugeOnboarding {
            constructor() {
                this.currentStep = 0;
                this.onboardingData = {};
                this.firebaseInitialized = false;
                this.firebaseUser = null;
                this.translations = {};
                this.supportedLanguages = {
                'en': { name: 'English', flag: '🇬🇧' },
                'de': { name: 'Deutsch', flag: '🇩🇪' },
                'fr': { name: 'Français', flag: '🇫🇷' },
                'es': { name: 'Español', flag: '🇪🇸' },
                'it': { name: 'Italiano', flag: '🇮🇹' },
                'pt': { name: 'Português', flag: '🇵🇹' },
                'nl': { name: 'Nederlands', flag: '🇳🇱' },
                'ru': { name: 'Русский', flag: '🇷🇺' },
                'ja': { name: '日本語', flag: '🇯🇵' },
                'zh': { name: '中文', flag: '🇨🇳' },
           };
                this.currentLanguage = this.detectLanguage();                 
                this.loadOnboardingData();
                this.updateProgressIndicator();
                this.initializeApp();
            }

            detectLanguage() {
                // Try saved preference first
                const savedLanguage = localStorage.getItem('zentrafuge_language');
                if (savedLanguage && this.supportedLanguages[savedLanguage]) {
                    return savedLanguage;
                }
                
                // Auto-detect from browser
                const browserLanguage = navigator.language.split('-')[0];
                if (this.supportedLanguages[browserLanguage]) {
                    return browserLanguage;
                }
                
                // Fallback to English
                return 'en';
            }

            async initializeApp() {
                try {
                    // Load translations first
                    await this.loadTranslations(this.currentLanguage);
                    
                    // Apply translations to UI
                    this.applyTranslations();
                    
                    // Setup language dropdown
                    this.setupLanguageDropdown();
                    
                    // Initialize Firebase
                    this.initializeFirebase();
                    
                    // Hide loading overlay
                    document.getElementById('loading-overlay').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading-overlay').style.display = 'none';
                    }, 300);
                    
                } catch (error) {
                    console.error('App initialization failed:', error);
                    this.showStatusMessage('Failed to load application. Please refresh the page.', 'error');
                }
            }

            async loadTranslations(language) {
                try {
                    console.log(`Loading translations for: ${language}`);
                    const response = await fetch(`/translations/${language}.json`);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to load ${language} translations`);
                    }
                    
                    this.translations = await response.json();
                    console.log('Translations loaded successfully');
                    return true;
                } catch (error) {
                    console.warn(`Failed to load ${language} translations, falling back to English:`, error);
                    
                    // Fallback to English
                    if (language !== 'en') {
                        try {
                            const response = await fetch('/translations/en.json');
                            this.translations = await response.json();
                            this.currentLanguage = 'en';
                            return true;
                        } catch (fallbackError) {
                            console.error('Failed to load English fallback:', fallbackError);
                            // Use hardcoded fallback
                            this.translations = this.getHardcodedFallback();
                            return false;
                        }
                    } else {
                        // Use hardcoded fallback for English
                        this.translations = this.getHardcodedFallback();
                        return false;
                    }
                }
            }

            getHardcodedFallback() {
                return {
                    welcomeTitle: 'Welcome to Zentrafuge',
                    caelIntro: "Hi, I'm Cael. I'm here to be your companion on this journey—whatever that looks like for you.",
                    welcomeDescription: "I'd love to get to know you through a few gentle questions.",
                    beginButton: "Let's begin",
                    authNotice: "Please log in to continue with onboarding.",
                    loginLink: "Click here to log in",
                    savingMessage: "Saving your preferences...",
                    errorSaving: "Error saving preferences. Continuing with local storage.",
                    successSaving: "Preferences saved successfully!",
                    offlineMode: "You can continue without logging in, but your preferences won't be saved to the cloud.",
                    authSuccess: "Authentication successful! Welcome back.",
                    offlineWarning: "Continuing in offline mode. Log in to save to cloud.",
                    emailNotVerified: "Please verify your email before continuing onboarding."
                };
            }

            applyTranslations() {
                // Apply translations to all elements with data-translate attribute
                document.querySelectorAll('[data-translate]').forEach(element => {
                    const key = element.getAttribute('data-translate');
                    if (this.translations[key]) {
                        element.textContent = this.translations[key];
                    }
                });

                // Apply placeholder translations
                document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                    const key = element.getAttribute('data-translate-placeholder');
                    if (this.translations[key]) {
                        element.placeholder = this.translations[key];
                    }
                });

                console.log('Translations applied successfully');
            }

            setupLanguageDropdown() {
                // Update current language display
                const currentLang = this.supportedLanguages[this.currentLanguage];
                document.getElementById('selected-language').textContent = currentLang.name;
                document.getElementById('selected-flag').textContent = currentLang.flag;

                // Populate language dropdown
                const languageDropdown = document.getElementById('language-dropdown');
                languageDropdown.innerHTML = '';
                
                Object.keys(this.supportedLanguages).forEach(langCode => {
                    const lang = this.supportedLanguages[langCode];
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'language-option-dropdown';
                    optionDiv.setAttribute('data-lang', langCode);
                    optionDiv.onclick = () => this.selectLanguage(langCode);

                    const flagSpan = document.createElement('span');
                    flagSpan.className = 'language-flag';
                    flagSpan.textContent = lang.flag;

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'language-name';
                    nameSpan.textContent = lang.name;

                    optionDiv.appendChild(flagSpan);
                    optionDiv.appendChild(nameSpan);
                    languageDropdown.appendChild(optionDiv);

                    if (langCode === this.currentLanguage) {
                        optionDiv.classList.add('selected');
                    }
                });
            }

            async selectLanguage(langCode) {
                if (langCode === this.currentLanguage) {
                    toggleLanguageDropdown();
                    return;
                }

                console.log(`Switching to language: ${langCode}`);
                
                // Show loading state
                document.getElementById('selected-language').textContent = 'Loading...';
                
                try {
                    // Load new translations
                    const oldLanguage = this.currentLanguage;
                    this.currentLanguage = langCode;
                    
                    const success = await this.loadTranslations(langCode);
                    if (success) {
                        // Save preference
                        localStorage.setItem('zentrafuge_language', langCode);
                        
                        // Apply new translations
                        this.applyTranslations();
                        this.setupLanguageDropdown();
                        
                        this.showStatusMessage(`Language changed to ${this.supportedLanguages[langCode].name}`, 'success');
                    } else {
                        throw new Error('Translation load failed');
                    }
                } catch (error) {
                    console.error('Language switch failed:', error);
                    this.currentLanguage = oldLanguage; // Revert
                    this.setupLanguageDropdown();
                    this.showStatusMessage('Failed to change language', 'error');
                }
                
                toggleLanguageDropdown();
            }

            initializeFirebase() {
                console.log('Initializing Firebase authentication...');
                
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK not loaded');
                    this.showStatusMessage('Firebase not available. Please check your connection.', 'error');
                    this.enableOfflineMode();
                    return;
                }

                try {
                    firebase.auth().onAuthStateChanged((user) => {
                        console.log('Auth state changed:', user ? user.uid : 'No user');
                        
                        if (user && !user.isAnonymous) {
                            // Check email verification
                            if (!user.emailVerified) {
                                this.showStatusMessage(this.translations.emailNotVerified || 'Please verify your email before continuing onboarding.', 'error');
                                document.getElementById('auth-notice').style.display = 'block';
                                document.getElementById('begin-button').disabled = true;
                                return;
                            }
                            
                            // Authenticated and verified user
                            this.firebaseUser = user;
                            this.firebaseInitialized = true;
                            this.onboardingData.user_id = user.uid;
                            this.onboardingData.email = user.email;
                            
                            // Hide auth notice and enable begin button
                            document.getElementById('auth-notice').style.display = 'none';
                            document.getElementById('begin-button').disabled = false;
                            
                            this.showStatusMessage(this.translations.authSuccess || 'Authentication successful!', 'success');
                        } else {
                            // Not authenticated - redirect to login
                            window.location.href = 'index.html';
                        }
                    });
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    window.location.href = 'index.html';
                }
            }

            enableOfflineMode() {
                console.log('Enabling offline mode...');
                this.firebaseUser = null;
                this.firebaseInitialized = false;
                
                // Show auth notice but also enable offline use
                const authNotice = document.getElementById('auth-notice');
                authNotice.style.display = 'block';
                
                // Enable begin button for offline use
                document.getElementById('begin-button').disabled = false;
                
                this.showStatusMessage(this.translations.offlineWarning || 'Continuing in offline mode', 'warning');
            }

            showStatusMessage(message, type) {
                const statusMessageDiv = document.getElementById('status-message');
                statusMessageDiv.textContent = message;
                statusMessageDiv.className = `status-message ${type}`;
                statusMessageDiv.style.display = 'block';
                setTimeout(() => {
                    statusMessageDiv.style.display = 'none';
                }, 5000);
            }

            async saveResponsesToFirestore(data) {
                if (!this.firebaseInitialized || !this.firebaseUser) {
                    console.log('Firebase not available, skipping cloud save');
                    return false;
                }

                try {
                    const db = firebase.firestore();
                    const userRef = db.collection('users').doc(this.firebaseUser.uid);
                    
                    const dataWithTimestamps = {
                        ...data,
                        onboardingComplete: true,  // ← KEY FLAG ADDED HERE
                        onboarding_completed_at: firebase.firestore.FieldValue.serverTimestamp(),
                        last_updated: firebase.firestore.FieldValue.serverTimestamp(),
                        version: "1.0",
                        emailVerified: true
                    };
                    
                    await userRef.set(dataWithTimestamps, { merge: true });
                    console.log('Successfully saved to Firestore with completion flag');
                    return true;
                } catch (error) {
                    console.error('Firestore save error:', error);
                    return false;
                }
            }

            async completeOnboarding() {
                console.log('Completing onboarding...');
                
                try {
                    this.collectAllFormData();
                    this.saveOnboardingData(); // Always save to localStorage

                    const completeButton = document.getElementById('complete-button');
                    const originalButtonText = completeButton.innerHTML;
                    const loadingSpinner = completeButton.querySelector('.loading-spinner');

                    completeButton.disabled = true;
                    completeButton.innerHTML = this.translations.savingMessage || 'Saving...';
                    if (loadingSpinner) {
                        loadingSpinner.style.display = 'inline-block';
                    }

                    this.showStatusMessage(this.translations.savingMessage || 'Saving your preferences...', 'warning');

                    // Try to save to Firestore if available
                    let firestoreSaved = false;
                    if (this.firebaseInitialized) {
                        try {
                            firestoreSaved = await this.saveResponsesToFirestore(this.onboardingData);
                        } catch (error) {
                            console.log('Firestore save failed:', error);
                        }
                    }

                    if (firestoreSaved) {
                        this.showStatusMessage(this.translations.successSaving || 'Preferences saved successfully!', 'success');
                    } else {
                        this.showStatusMessage(this.translations.errorSaving || 'Error saving preferences. Continuing with local storage.', 'error');
                    }

                    // Restore button state
                    completeButton.disabled = false;
                    completeButton.innerHTML = originalButtonText;
                    if (loadingSpinner) {
                        loadingSpinner.style.display = 'none';
                    }

                    // Redirect after delay
                    setTimeout(() => {
                        window.location.href = './chat.html';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error in completeOnboarding:', error);
                    this.showStatusMessage('An error occurred. Please try again.', 'error');
                    
                    // Restore button state on error
                    const completeButton = document.getElementById('complete-button');
                    completeButton.disabled = false;
                    completeButton.innerHTML = `<span data-translate="completeButton">${this.translations.completeButton || 'Begin our journey'}</span> <span class="loading-spinner"></span>`;
                }
            }

            loadOnboardingData() {
                const savedData = localStorage.getItem('zentrafuge_onboarding_data');
                if (savedData) {
                    this.onboardingData = JSON.parse(savedData);
                }
            }

            saveOnboardingData() {
                localStorage.setItem('zentrafuge_onboarding_data', JSON.stringify(this.onboardingData));
            }

            collectAllFormData() {
                console.log('Collecting data from all steps...');
                
                // Reset arrays to avoid duplicates
                this.onboardingData.sources_of_meaning = [];
                this.onboardingData.effective_support = [];

                // Collect from ALL steps (0-4)
                for (let stepNum = 0; stepNum <= 4; stepNum++) {
                    const stepElement = document.getElementById(`step-${stepNum}`);
                    if (!stepElement) continue;

                    // Radio buttons
                    stepElement.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                        this.onboardingData[input.name] = input.value;
                    });

                    // Checkboxes
                    stepElement.querySelectorAll('input[type="checkbox"]:checked').forEach(input => {
                        if (!this.onboardingData[input.name]) {
                            this.onboardingData[input.name] = [];
                        }
                        if (!this.onboardingData[input.name].includes(input.value)) {
                            this.onboardingData[input.name].push(input.value);
                        }
                    });

                    // Text inputs
                    stepElement.querySelectorAll('input[type="text"], textarea').forEach(input => {
                        if (input.id && input.value) {
                            this.onboardingData[input.id] = input.value;
                        }
                    });
                }

                // Add metadata
                if (!this.onboardingData.user_id) {
                    this.onboardingData.user_id = this.firebaseUser ? this.firebaseUser.uid : `local_${Date.now()}`;
                }
                this.onboardingData.language = this.currentLanguage;
                this.onboardingData.completed_at = new Date().toISOString();
                
                console.log('Final collected data:', this.onboardingData);
            }

            collectFormData() {
                const currentStepElement = document.getElementById(`step-${this.currentStep}`);
                if (!currentStepElement) return;

                // Radio buttons
                currentStepElement.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                    this.onboardingData[input.name] = input.value;
                });

                // Checkboxes
                currentStepElement.querySelectorAll('input[type="checkbox"]:checked').forEach(input => {
                    if (!this.onboardingData[input.name]) {
                        this.onboardingData[input.name] = [];
                    }
                    if (!this.onboardingData[input.name].includes(input.value)) {
                        this.onboardingData[input.name].push(input.value);
                    }
                });

                // Text inputs
                currentStepElement.querySelectorAll('input[type="text"], textarea').forEach(input => {
                    if (input.id) {
                        this.onboardingData[input.id] = input.value;
                    }
                });

                // Add metadata
                if (!this.onboardingData.user_id) {
                    this.onboardingData.user_id = this.firebaseUser ? this.firebaseUser.uid : `local_${Date.now()}`;
                }
                this.onboardingData.language = this.currentLanguage;
            }

            nextStep() {
                this.collectFormData();
                this.saveOnboardingData();

                const currentStepElement = document.getElementById(`step-${this.currentStep}`);
                if (currentStepElement) {
                    currentStepElement.classList.remove('active');
                    currentStepElement.classList.add('hidden');
                }

                this.currentStep++;
                if (this.currentStep > 4) {
                    return;
                }

                const nextStepElement = document.getElementById(`step-${this.currentStep}`);
                if (nextStepElement) {
                    nextStepElement.classList.remove('hidden');
                    nextStepElement.classList.add('active');
                }
                this.updateProgressIndicator();
            }

            prevStep() {
                this.collectFormData();
                this.saveOnboardingData();

                const currentStepElement = document.getElementById(`step-${this.currentStep}`);
                if (currentStepElement) {
                    currentStepElement.classList.remove('active');
                    currentStepElement.classList.add('hidden');
                }

                this.currentStep--;
                if (this.currentStep < 0) {
                    this.currentStep = 0;
                }

                const prevStepElement = document.getElementById(`step-${this.currentStep}`);
                if (prevStepElement) {
                    prevStepElement.classList.remove('hidden');
                    prevStepElement.classList.add('active');
                }
                this.updateProgressIndicator();
            }

            updateProgressIndicator() {
                document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index === this.currentStep);
                    dot.classList.toggle('completed', index < this.currentStep);
                });
            }
        }

        // Global variables
        let onboarding;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing onboarding...');
            onboarding = new ZentrafugeOnboarding();
        });

        function handleNextStep() {
            if (onboarding) {
                onboarding.nextStep();
            }
        }

        function handlePrevStep() {
            if (onboarding) {
                onboarding.prevStep();
            }
        }

        function handleCompleteOnboarding() {
            if (onboarding) {
                onboarding.completeOnboarding();
            }
        }

        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('language-dropdown');
            const dropdownButton = document.querySelector('.language-dropdown');
            dropdown.classList.toggle('open');
            dropdownButton.classList.toggle('open');
        }

        // Close dropdown if clicked outside
        window.onclick = function(event) {
            if (!event.target.matches('.language-dropdown') && !event.target.closest('.language-dropdown')) {
                const dropdowns = document.getElementsByClassName('language-options-dropdown');
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('open')) {
                        openDropdown.classList.remove('open');
                        document.querySelector('.language-dropdown').classList.remove('open');
                    }
                }
            }
        }
    </script>
</body>
</html>
