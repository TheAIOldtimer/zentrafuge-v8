<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zentrafuge √ó Preferences</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="Zentrafuge-WIDE-Logo-Transparent.png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="auth-loading" id="auth-loading" style="display: block;">
    <div class="loading-spinner"></div>
    <div class="auth-message">Verifying access...</div>
  </div>
  
  <header id="main-header" style="display: none;">
    <div class="header-left">
      <img src="Zentrafuge-WIDE-Logo-Transparent.png" alt="Zentrafuge Logo"
           onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<h1>Zentrafuge √ó Preferences</h1>');" />
      <span id="user-info">Welcome, [User]</span>
    </div>
  
    <div class="header-center">
      <nav class="main-nav">
        <button onclick="window.location.href='chat.html'" class="nav-btn">Chat</button>
        <button onclick="window.location.href='dashboard.html'" class="nav-btn">Dashboard</button>
        <button onclick="window.location.href='preferences.html'" class="nav-btn active">Preferences</button>
        <button onclick="showChartsModal()" class="nav-btn">Charts</button>
      </nav>
    </div>
  
    <div class="header-right">
      <button onclick="window.location.href='donate.html'" class="donate-btn">Donate</button>
      <button onclick="handleLogout()" class="logout-btn">Logout</button>
    </div>
  </header>

  <div id="preferences" style="display: none;">
    <div class="preferences-container">
      <div class="preferences-header">
        <h2>üéØ AI Communication Preferences</h2>
        <p>Customize how your companion interacts with you. These settings help create a more personalized and comfortable experience.</p>
      </div>

      <div class="preferences-grid">
        <!-- AI Companion Name -->
        <div class="preference-group">
          <label for="ai-name">
            <span class="preference-icon">ü§ñ</span>
            <strong>Companion Name</strong>
          </label>
          <input type="text" id="ai-name" class="preference-input" value="Cael" maxlength="50" />
          <small class="preference-description">What would you like to call your AI companion?</small>
        </div>

        <!-- Language Style -->
        <div class="preference-group">
          <label for="language-style">
            <span class="preference-icon">üí¨</span>
            <strong>Language Style</strong>
          </label>
          <select id="language-style" class="preference-select">
            <option value="direct">Direct & Straightforward</option>
            <option value="warm">Warm & Supportive</option>
            <option value="formal">Formal & Professional</option>
            <option value="casual">Casual & Friendly</option>
          </select>
          <small class="preference-description">How would you like your companion to communicate with you?</small>
        </div>

        <!-- Response Length -->
        <div class="preference-group">
          <label for="response-length">
            <span class="preference-icon">üìè</span>
            <strong>Response Length</strong>
          </label>
          <select id="response-length" class="preference-select">
            <option value="brief">Brief responses</option>
            <option value="moderate">Moderate detail</option>
            <option value="detailed">Detailed responses</option>
          </select>
          <small class="preference-description">How much detail do you prefer in responses?</small>
        </div>

        <!-- Military Context -->
        <div class="preference-group">
          <label for="military-context">
            <span class="preference-icon">üéñÔ∏è</span>
            <strong>Military Recognition</strong>
          </label>
          <select id="military-context" class="preference-select">
            <option value="auto">Auto-detect when mentioned</option>
            <option value="always">Always acknowledge my service</option>
            <option value="never">Keep conversations general</option>
          </select>
          <small class="preference-description">How should your companion handle military context?</small>
        </div>

        <!-- Emotional Pacing -->
        <div class="preference-group">
          <label for="emotional-pacing">
            <span class="preference-icon">‚è±Ô∏è</span>
            <strong>Emotional Pacing</strong>
          </label>
          <select id="emotional-pacing" class="preference-select">
            <option value="gentle">Take things slowly</option>
            <option value="moderate">Balanced approach</option>
            <option value="direct">Address things head-on</option>
          </select>
          <small class="preference-description">How quickly should conversations deepen?</small>
        </div>

        <!-- Memory Preferences -->
        <div class="preference-group">
          <label for="memory-usage">
            <span class="preference-icon">üß†</span>
            <strong>Memory Usage</strong>
          </label>
          <select id="memory-usage" class="preference-select">
            <option value="contextual">Reference past conversations naturally</option>
            <option value="minimal">Keep conversations fresh</option>
            <option value="detailed">Remember everything important</option>
          </select>
          <small class="preference-description">How should your companion use conversation history?</small>
        </div>

        <!-- Session Reminders -->
        <div class="preference-group">
          <label for="session-reminders">
            <span class="preference-icon">üîî</span>
            <strong>Check-in Reminders</strong>
          </label>
          <select id="session-reminders" class="preference-select">
            <option value="gentle">Gentle occasional check-ins</option>
            <option value="regular">Regular wellness reminders</option>
            <option value="minimal">Only when I reach out</option>
          </select>
          <small class="preference-description">How often should your companion check in with you?</small>
        </div>
      </div>

      <div class="preferences-actions">
        <button onclick="saveUserPreferences()" class="btn btn-primary">
          üíæ Save Preferences
        </button>
        <button onclick="testCurrentPreferences()" class="btn btn-secondary">
          üß™ Test Settings
        </button>
        <button onclick="resetUserPreferences()" class="btn btn-outline">
          üîÑ Reset to Defaults
        </button>
      </div>

      <div id="preferences-status" class="status-message"></div>
    </div>
  </div>

  <!-- Loading and error states -->
  <div id="error-state" style="display: none;">
    <div class="error-container">
      <h2>‚ö†Ô∏è Access Required</h2>
      <p>Please log in to customize your preferences.</p>
      <button onclick="window.location.href='index.html'" class="btn btn-primary">
        Go to Login
      </button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

  <!-- App Scripts -->
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/preferences.js"></script>

  <script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        console.log('üîß Preferences page loading...');
        
        // Initialize Firebase
        const firebaseConfig = window.firebaseConfig || DEFAULT_FIREBASE_CONFIG;
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        
        // Check authentication
        firebase.auth().onAuthStateChanged(async function(user) {
          const authLoading = document.getElementById('auth-loading');
          const mainHeader = document.getElementById('main-header');
          const preferences = document.getElementById('preferences');
          const errorState = document.getElementById('error-state');
          
          if (user && user.emailVerified) {
            console.log('‚úÖ User authenticated:', user.email);
            
            // Update user info
            const userInfo = document.getElementById('user-info');
            userInfo.textContent = `Welcome, ${user.displayName || user.email}`;
            
            // Load user preferences
            await loadUserPreferences();
            loadPreferencesIntoForm();
            
            // Show main interface
            authLoading.style.display = 'none';
            mainHeader.style.display = 'flex';
            preferences.style.display = 'block';
            
          } else if (user && !user.emailVerified) {
            console.log('‚ö†Ô∏è User not verified');
            authLoading.style.display = 'none';
            errorState.style.display = 'block';
            errorState.querySelector('p').textContent = 'Please verify your email before accessing preferences.';
            
          } else {
            console.log('‚ùå User not authenticated');
            authLoading.style.display = 'none';
            errorState.style.display = 'block';
          }
        });
        
      } catch (error) {
        console.error('‚ùå Preferences page initialization error:', error);
        document.getElementById('auth-loading').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
      }
    });

    // Handle logout
    async function handleLogout() {
      try {
        await firebase.auth().signOut();
        window.location.href = 'index.html';
      } catch (error) {
        console.error('‚ùå Logout error:', error);
      }
    }

    // Show charts modal (placeholder)
    function showChartsModal() {
      alert('üìä Charts feature coming soon!');
    }
  </script>

  <style>
    .preference-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s ease;
      background: #fff;
    }

    .preference-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .preference-input:invalid {
      border-color: #dc3545;
    }

    .preferences-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .preference-group {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid #e9ecef;
    }

    .preference-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #495057;
    }

    .preference-icon {
      font-size: 1.2rem;
    }

    .preference-select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      background: #fff;
      cursor: pointer;
    }

    .preference-select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .preference-description {
      display: block;
      margin-top: 0.5rem;
      color: #6c757d;
      font-size: 0.875rem;
      line-height: 1.4;
    }

    .preferences-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin: 2rem 0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-outline {
      background: transparent;
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
    }

    .status-message {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .status-message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }

    .error-container {
      text-align: center;
      padding: 3rem;
      max-width: 500px;
      margin: 2rem auto;
    }

    .error-container h2 {
      color: #dc3545;
      margin-bottom: 1rem;
    }

    .error-container p {
      color: #6c757d;
      margin-bottom: 2rem;
    }
  </style>
</body>
</html>
