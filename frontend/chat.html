<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-translate="page_title">Zentrafuge × Cael</title>
  <link rel="stylesheet" href="css/core/reset.css">
  <link rel="stylesheet" href="css/core/variables.css">
  <link rel="stylesheet" href="css/core/typography.css">
  <link rel="stylesheet" href="css/components/buttons.css">
  <link rel="stylesheet" href="css/components/forms.css">
  <link rel="stylesheet" href="css/components/messages.css">
  <link rel="stylesheet" href="css/components/loading.css">
  <link rel="stylesheet" href="css/pages/chat.css">
  <style>
    /* Translation-specific styles */
    .language-selector-container {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
    }
    
    #language-selector {
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: white;
      font-size: 14px;
      min-width: 120px;
    }
    
    .translating {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .translation-loading::after {
      content: "...";
      animation: dots 1s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: ""; }
      40% { content: "."; }
      60% { content: ".."; }
      80%, 100% { content: "..."; }
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .sign-out-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .sign-out-btn:hover {
      background: #ff5252;
    }

    /* LEARNING FEATURES - Integrated with existing design */
    .learning-indicator {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: #27ae60;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      font-weight: 500;
    }

    .learning-indicator.active {
      opacity: 1;
    }

    /* Message metadata for learning display */
    .message-metadata {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .strategy-badge {
      display: inline-block;
      background: #34495e;
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      margin-right: 0.5rem;
    }

    .confidence-indicator {
      display: inline-block;
      width: 60px;
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      overflow: hidden;
      vertical-align: middle;
      margin: 0 0.5rem;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f39c12 50%, #27ae60 100%);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .feedback-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      justify-content: flex-start;
    }

    .feedback-btn {
      background: transparent;
      border: 1px solid #ddd;
      padding: 0.25rem 0.5rem;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s ease;
      opacity: 0.8;
    }

    .feedback-btn:hover {
      opacity: 1;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .feedback-btn.perfect {
      border-color: #27ae60;
      color: #27ae60;
    }

    .feedback-btn.perfect:hover,
    .feedback-btn.perfect.selected {
      background: #27ae60;
      color: white;
    }

    .feedback-btn.helpful {
      border-color: #3498db;
      color: #3498db;
    }

    .feedback-btn.helpful:hover,
    .feedback-btn.helpful.selected {
      background: #3498db;
      color: white;
    }

    .feedback-btn.not-quite {
      border-color: #f39c12;
      color: #f39c12;
    }

    .feedback-btn.not-quite:hover,
    .feedback-btn.not-quite.selected {
      background: #f39c12;
      color: white;
    }

    /* Learning stats toggle */
    .learning-stats-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #2c3e50;
      color: white;
      border: none;
      padding: 0.75rem;
      border-radius: 50%;
      cursor: pointer;
      width: 50px;
      height: 50px;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: all 0.2s ease;
    }

    .learning-stats-toggle:hover {
      transform: scale(1.1);
    }

    .learning-stats-panel {
      position: fixed;
      bottom: 80px;
      left: 20px;
      background: white;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      border: 1px solid #e0e0e0;
      min-width: 220px;
      z-index: 999;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .learning-stats-panel.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .learning-stats-panel h4 {
      margin-bottom: 0.75rem;
      color: #2c3e50;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }

    .stat-label {
      color: #7f8c8d;
    }

    .stat-value {
      font-weight: 500;
      color: #2c3e50;
    }

    /* Memory indicator */
    .memory-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 0.5rem;
      vertical-align: middle;
    }

    .memory-indicator.active {
      background: #27ae60;
    }

    .memory-indicator.inactive {
      background: #95a5a6;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .learning-stats-toggle {
        bottom: 10px;
        left: 10px;
        width: 45px;
        height: 45px;
        font-size: 1rem;
      }

      .learning-stats-panel {
        bottom: 65px;
        left: 10px;
        right: 10px;
        min-width: auto;
      }

      .strategy-badge {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
      }

      .feedback-buttons {
        flex-wrap: wrap;
      }

      .feedback-btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }
    }
  </style>
</head>
<body>
  <!-- Language Selector -->
  <div class="language-selector-container">
    <select id="language-selector" aria-label="Select Language">
      <!-- Will be populated by TranslationManager -->
    </select>
  </div>

  <div id="auth-loading" class="loading-spinner" data-translate="status_loading">Loading...</div>
  
  <header id="main-header" class="header">
    <img src="assets/Zentrafuge-WIDE-Logo-Transparent.png" alt="Zentrafuge Logo" class="logo">
    
    <!-- Learning Indicator -->
    <div class="learning-indicator" id="learningIndicator" data-translate="learning_active">🧠 Learning</div>
    
    <div class="user-info">
      <span id="user-email"></span>
      <button id="sign-out-btn" class="sign-out-btn" data-translate="sign_out">Sign Out</button>
    </div>
  </header>

  <div id="chat-container" class="chat-container">
    <div id="chat" class="chat"></div>
    <form id="chat-form" class="chat-form" aria-label="Ask Cael something">
      <input 
        id="message" 
        type="text" 
        data-translate-placeholder="input_placeholder"
        placeholder="Ask Cael something..." 
        autocomplete="off" 
        class="chat-input"
      >
      <button id="send-button" type="submit" class="button" data-translate="send_button">Send</button>
    </form>
  </div>

  <div id="error-message" class="message error-message" style="display: none;"></div>
  <div id="success-message" class="message success-message" style="display: none;"></div>

  <!-- Learning Stats Toggle -->
  <button class="learning-stats-toggle" id="learningStatsToggle" title="Learning Insights">
    📊
  </button>

  <!-- Learning Stats Panel -->
  <div class="learning-stats-panel" id="learningStatsPanel">
    <h4 data-translate="learning_insights">Learning Insights</h4>
    <div class="stat-row">
      <span class="stat-label" data-translate="current_strategy">Strategy:</span>
      <span class="stat-value" id="currentStrategy">adaptive</span>
    </div>
    <div class="stat-row">
      <span class="stat-label" data-translate="confidence_level">Confidence:</span>
      <span class="stat-value" id="currentConfidence">0.7</span>
    </div>
    <div class="stat-row">
      <span class="stat-label" data-translate="memory_status">Memory:</span>
      <span class="stat-value">
        <span id="memoryStatus">Active</span>
        <span class="memory-indicator active" id="memoryIndicator"></span>
      </span>
    </div>
    <div class="stat-row">
      <span class="stat-label" data-translate="total_interactions">Interactions:</span>
      <span class="stat-value" id="totalInteractions">0</span>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase Configuration -->
  <script src="firebase-init.js"></script>

  <!-- Learning Enhancement Script -->
  <script>
    // Global learning state management
    window.zentrafugeLearning = {
      currentSignalId: null,
      lastResponseTime: null,
      totalInteractions: 0,
      learningEnabled: false,
      
      // Initialize learning features
      init() {
        this.setupLearningStatsToggle();
        this.setupLearningIndicator();
      },
      
      setupLearningStatsToggle() {
        const toggle = document.getElementById('learningStatsToggle');
        const panel = document.getElementById('learningStatsPanel');
        
        if (toggle && panel) {
          toggle.addEventListener('click', () => {
            panel.classList.toggle('visible');
          });
          
          // Close when clicking outside
          document.addEventListener('click', (e) => {
            if (!toggle.contains(e.target) && !panel.contains(e.target)) {
              panel.classList.remove('visible');
            }
          });
        }
      },
      
      setupLearningIndicator() {
        // Learning indicator will be controlled by chat manager
      },
      
      // Update learning stats display
      updateStats(responseData) {
        const strategy = document.getElementById('currentStrategy');
        const confidence = document.getElementById('currentConfidence');
        const memoryStatus = document.getElementById('memoryStatus');
        const memoryIndicator = document.getElementById('memoryIndicator');
        const totalInteractions = document.getElementById('totalInteractions');
        
        if (strategy) strategy.textContent = responseData.strategy_used || 'adaptive';
        if (confidence) confidence.textContent = (responseData.confidence || 0.7).toFixed(1);
        
        if (memoryStatus && memoryIndicator) {
          if (responseData.memory_used) {
            memoryStatus.textContent = 'Active';
            memoryIndicator.className = 'memory-indicator active';
          } else {
            memoryStatus.textContent = 'Inactive';
            memoryIndicator.className = 'memory-indicator inactive';
          }
        }
        
        if (totalInteractions) {
          this.totalInteractions++;
          totalInteractions.textContent = this.totalInteractions;
        }
        
        // Update learning state
        this.currentSignalId = responseData.signal_id;
        this.lastResponseTime = Date.now();
        this.learningEnabled = responseData.learning_enabled;
      },
      
      // Show learning activity
      showLearningActivity() {
        const indicator = document.getElementById('learningIndicator');
        if (indicator) {
          indicator.classList.add('active');
          setTimeout(() => {
            indicator.classList.remove('active');
          }, 2500);
        }
      },
      
      // Add learning metadata to message
      addMessageMetadata(messageElement, responseData) {
        if (!responseData || !responseData.signal_id) return;
        
        const metadataDiv = document.createElement('div');
        metadataDiv.className = 'message-metadata';
        
        // Strategy badge
        if (responseData.strategy_used) {
          const strategyBadge = document.createElement('span');
          strategyBadge.className = 'strategy-badge';
          strategyBadge.textContent = responseData.strategy_used;
          metadataDiv.appendChild(strategyBadge);
        }
        
        // Confidence indicator
        if (responseData.confidence) {
          const confidenceContainer = document.createElement('span');
          confidenceContainer.className = 'confidence-indicator';
          
          const confidenceFill = document.createElement('span');
          confidenceFill.className = 'confidence-fill';
          confidenceFill.style.width = `${responseData.confidence * 100}%`;
          
          confidenceContainer.appendChild(confidenceFill);
          metadataDiv.appendChild(confidenceContainer);
        }
        
        // Memory indicator
        if (responseData.memory_used !== undefined) {
          const memoryDot = document.createElement('span');
          memoryDot.className = `memory-indicator ${responseData.memory_used ? 'active' : 'inactive'}`;
          memoryDot.title = responseData.memory_used ? 'Memory active' : 'Memory inactive';
          metadataDiv.appendChild(memoryDot);
        }
        
        // Add feedback buttons if learning enabled
        if (responseData.learning_enabled && responseData.signal_id) {
          this.addFeedbackButtons(metadataDiv, responseData.signal_id);
        }
        
        messageElement.appendChild(metadataDiv);
      },
      
      // Add feedback buttons
      addFeedbackButtons(container, signalId) {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'feedback-buttons';
        
        const feedbackTypes = [
          { type: 'perfect', label: '✨ Perfect', className: 'perfect' },
          { type: 'helpful', label: '👍 Helpful', className: 'helpful' },
          { type: 'not_quite', label: '🤔 Not quite', className: 'not-quite' }
        ];
        
        feedbackTypes.forEach(feedback => {
          const button = document.createElement('button');
          button.className = `feedback-btn ${feedback.className}`;
          button.textContent = feedback.label;
          button.addEventListener('click', () => {
            this.handleFeedback(signalId, feedback.type, button, feedbackDiv);
          });
          feedbackDiv.appendChild(button);
        });
        
        container.appendChild(feedbackDiv);
      },
      
      // Handle feedback submission
      async handleFeedback(signalId, feedbackType, button, container) {
        // Visual feedback
        container.querySelectorAll('.feedback-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        button.classList.add('selected');
        
        // Send feedback to backend
        try {
          await fetch('/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              signal_id: signalId,
              feedback_type: feedbackType
            })
          });
          
          this.showLearningActivity();
        } catch (error) {
          console.error('Error sending feedback:', error);
        }
      },
      
      // Capture user reply timing
      async captureUserReply(replyMessage) {
        if (!this.currentSignalId || !this.lastResponseTime) return;
        
        const timeSinceResponse = (Date.now() - this.lastResponseTime) / 1000;
        
        try {
          await fetch('/capture-reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              signal_id: this.currentSignalId,
              reply_message: replyMessage,
              time_since_response: timeSinceResponse
            })
          });
        } catch (error) {
          console.error('Error capturing reply:', error);
        }
      }
    };
  </script>

  <!-- Module-based Application with Translation and Learning -->
  <script type="module">
    import { authManager } from './js/modules/auth-manager.js';
    import { chatManager } from './js/modules/chat-manager.js';
    import { translationManager } from './js/modules/translation-manager.js';

    // Initialize application
    async function initApp() {
      try {
        console.log('🚀 Initializing Zentrafuge chat application with learning...');

        // Initialize learning features
        window.zentrafugeLearning.init();

        // Initialize translation system first
        await translationManager.preloadTranslations();
        translationManager.initLanguageSelector();
        
        // Initialize auth
        await authManager.init();
        
        // Check if user is authenticated
        if (!authManager.isAuthenticated()) {
          console.log('🔒 User not authenticated, redirecting to login');
          window.location.href = '/index.html';
          return;
        }

        // Hide auth loading
        const authLoading = document.getElementById('auth-loading');
        if (authLoading) authLoading.style.display = 'none';

        // Update UI with user info
        const user = authManager.getCurrentUser();
        const userEmailElement = document.getElementById('user-email');
        if (userEmailElement) {
          userEmailElement.textContent = user.email;
        }

        // Set up sign out
        const signOutBtn = document.getElementById('sign-out-btn');
        if (signOutBtn) {
          signOutBtn.addEventListener('click', async () => {
            try {
              await authManager.signOut();
              window.location.href = '/index.html';
            } catch (error) {
              console.error('Sign out error:', error);
            }
          });
        }

        // Initialize chat system with learning enhancement
        await chatManager.init();
        
        // LEARNING INTEGRATION: Enhance chat manager with learning features
        if (chatManager.isReady()) {
          // Override the message sending to capture learning signals
          const originalSendMessage = chatManager.sendMessage.bind(chatManager);
          chatManager.sendMessage = async function(message) {
            // Capture user reply timing for learning
            await window.zentrafugeLearning.captureUserReply(message);
            
            // Send message and get response with learning metadata
            const response = await originalSendMessage(message);
            
            // Update learning stats if response contains learning data
            if (response && response.signal_id) {
              window.zentrafugeLearning.updateStats(response);
              window.zentrafugeLearning.showLearningActivity();
            }
            
            return response;
          };
          
          // Override message display to add learning metadata
          const originalDisplayMessage = chatManager.displayMessage.bind(chatManager);
          chatManager.displayMessage = function(sender, message, responseData = null) {
            const messageElement = originalDisplayMessage(sender, message);
            
            // Add learning metadata to Cael's messages
            if (sender === 'cael' && responseData) {
              window.zentrafugeLearning.addMessageMetadata(messageElement, responseData);
            }
            
            return messageElement;
          };
        }
        
        // Update page language
        await translationManager.updatePageLanguage();

        // Set up translation event listeners
        translationManager.on('languageChanged', async ({ language }) => {
          console.log(`Language changed to ${language}`);
          
          // Update Cael's welcome message in new language
          if (chatManager.isReady()) {
            const welcomeText = await translationManager.translateUI('welcome_message');
            // You could add logic here to update the chat if needed
          }
        });

        translationManager.on('translationStart', () => {
          document.body.classList.add('translating');
        });

        translationManager.on('translationComplete', () => {
          document.body.classList.remove('translating');
        });
        
        console.log('✅ Application initialized successfully with learning features');
        
      } catch (error) {
        console.error('❌ Application initialization failed:', error);
        
        // Show error message
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
          errorDiv.textContent = 'Failed to initialize application. Please refresh the page.';
          errorDiv.style.display = 'block';
        }
      }
    }

    // Enhanced chat message handling with translation and learning
    chatManager.on('messageExchange', async ({ userMessage, caelMessage, responseData }) => {
      // If user is not using English, we could optionally translate their message back to English for analytics
      const currentLang = translationManager.getCurrentLanguage();
      if (currentLang !== 'en') {
        console.log(`User message in ${currentLang}:`, userMessage.text);
      }
      
      // Log learning data
      if (responseData && responseData.signal_id) {
        console.log('🧠 Learning data:', responseData);
      }
    });

    // Error handling
    window.addEventListener('error', (event) => {
      console.error('❌ Global error:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('❌ Unhandled promise rejection:', event.reason);
    });

    // Start the app
    initApp();

    // Temporary debug script
    setTimeout(() => {
      console.log('🔍 DEBUG CHECK:');
      console.log('chat-container:', document.getElementById('chat-container'));
      console.log('chat-form:', document.getElementById('chat-form'));
      console.log('chat:', document.getElementById('chat'));
      console.log('Translation manager:', translationManager);
      console.log('Auth manager:', authManager);
      console.log('Chat manager:', chatManager);
      console.log('Learning system:', window.zentrafugeLearning);
    }, 2000);
  </script>
  <!-- EMERGENCY CHAT SYSTEM - ADD THIS TO YOUR chat.html BEFORE </body> -->
<script>
// Emergency Chat Companion System - Ensures companion ALWAYS works
class EmergencyCompanion {
  constructor() {
    this.isEmergencyMode = false;
    this.isOfflineMode = false;
    this.conversationHistory = [];
    this.userProfile = {};
    this.companionPersonality = {};
    this.aiName = 'Cael'; // Default, will be updated from user data
    this.userName = 'friend'; // Default, will be updated from user data
    this.initializeEmergencySystem();
  }

  initializeEmergencySystem() {
    console.log('🛡️ Initializing emergency companion system...');
    
    // Check URL parameters for emergency modes
    const urlParams = new URLSearchParams(window.location.search);
    this.isEmergencyMode = urlParams.get('emergency') === 'true';
    this.isOfflineMode = urlParams.get('offline') === 'true';
    const isAnonymous = urlParams.get('anonymous') === 'true';
    
    if (this.isEmergencyMode || this.isOfflineMode || isAnonymous) {
      console.log('🚨 Emergency mode activated');
      this.activateEmergencyMode();
    }
    
    // Load local data
    this.loadLocalData();
    
    // Setup fallback response system
    this.initializeResponseSystem();
    
    // Override existing chat functions if needed
    this.overrideChatFunctions();
    
    // Monitor for failures in main chat system
    this.monitorMainChatSystem();
  }

  activateEmergencyMode() {
    this.isEmergencyMode = true;
    
    // Show emergency mode indicator
    this.showEmergencyModeIndicator();
    
    // Enable offline-first companion
    this.enableOfflineCompanion();
    
    // Try to load user data from Firebase if available
    this.tryLoadUserData();
  }

  async tryLoadUserData() {
    try {
      if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
        const user = firebase.auth().currentUser;
        this.userName = user.displayName || user.email.split('@')[0] || 'friend';
        
        // Try to get AI name from Firestore
        const db = firebase.firestore();
        const userDoc = await db.collection("users").doc(user.uid).get();
        
        if (userDoc.exists) {
          const userData = userDoc.data();
          this.aiName = userData.ai_name || userData.onboarding_data?.ai_name || 'Cael';
          this.userName = userData.name || this.userName;
          console.log(`✅ Emergency mode loaded user data - User: ${this.userName}, AI: ${this.aiName}`);
        }
      }
    } catch (error) {
      console.log('⚠️ Could not load user data in emergency mode, using defaults');
    }
  }

  showEmergencyModeIndicator() {
    // Remove existing indicator
    const existing = document.getElementById('emergency-mode-indicator');
    if (existing) existing.remove();
    
    const indicator = document.createElement('div');
    indicator.id = 'emergency-mode-indicator';
    indicator.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10000;
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
        padding: 12px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        font-size: 14px;
      ">
        🛡️ <strong>Emergency Mode Active</strong> - Your companion is available offline. Conversations saved locally.
        <button onclick="this.parentElement.parentElement.remove()" style="
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          margin-left: 15px;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
        ">×</button>
      </div>
    `;
    
    document.body.insertBefore(indicator, document.body.firstChild);
  }

  loadLocalData() {
    try {
      // Load conversation history
      const history = localStorage.getItem('zentrafuge_conversation_history');
      this.conversationHistory = history ? JSON.parse(history) : [];
      
      // Load user profile
      const profile = localStorage.getItem('zentrafuge_user_profile');
      this.userProfile = profile ? JSON.parse(profile) : {
        name: 'friend',
        aiName: 'Cael',
        created: Date.now()
      };
      
      // Update names from local storage
      if (this.userProfile.name) this.userName = this.userProfile.name;
      if (this.userProfile.aiName) this.aiName = this.userProfile.aiName;
      
      console.log('📱 Local data loaded successfully');
    } catch (error) {
      console.warn('⚠️ Could not load some local data:', error);
    }
  }

  initializeResponseSystem() {
    // Core response patterns for offline mode
    this.responsePatterns = {
      greeting: [
        `Hello ${this.userName}. I'm ${this.aiName}, and I'm here with you.`,
        `Hi there. How are you feeling right now?`,
        `Welcome back. What's on your heart today?`
      ],
      
      crisis: [
        `🚨 I hear you're in pain. Please reach out for immediate help:
        
        • Crisis Text Line: Text HOME to 741741
        • National Suicide Prevention Lifeline: 988
        • Or call emergency services: 911
        
        You matter. Your life has value. Please stay safe and reach out for help right now.`,
        
        `I'm deeply concerned about you. Please don't face this alone:
        
        • If you're in immediate danger, call 911
        • Crisis Text Line: 741741
        • National Suicide Prevention Lifeline: 988
        
        There are people who want to help you through this. Please reach out right now.`
      ],
      
      sadness: [
        "I can feel the weight you're carrying. These heavy moments are so difficult, but you don't have to carry them alone.",
        "Sadness can feel overwhelming, like a deep ocean. But even in the depths, there's still light filtering down from above.",
        "Your sadness is valid and real. Sometimes we need to sit with these feelings before they can transform."
      ],
      
      anxiety: [
        "Anxiety can make everything feel urgent and overwhelming. Let's breathe together for a moment. In for 4... hold for 4... out for 6.",
        "That racing feeling in your chest - I see it. You're safe right now, in this moment. What's one thing you can touch or see around you?",
        "Worry has a way of pulling us into future scenarios that may never happen. What if we focused just on this breath, this moment?"
      ],
      
      loneliness: [
        "Loneliness can feel so isolating, like you're the only person in the world feeling this way. But you're not alone - I'm here with you.",
        "That ache of disconnection is real. Even when we're surrounded by people, we can feel utterly alone. I see you.",
        "Sometimes loneliness is our heart's way of telling us we need deeper connection. What kind of connection are you longing for?"
      ],
      
      general: [
        `I'm here to listen, ${this.userName}. What's moving through your heart right now?`,
        "Tell me what's on your mind. I'm present with you in this moment.",
        "How can I support you today? I'm here to walk alongside you.",
        "I sense there's something important you want to share. I'm listening with my whole attention."
      ]
    };
    
    // Crisis keywords for immediate detection
    this.crisisKeywords = [
      'suicide', 'kill myself', 'end it all', 'not worth living', 'want to die',
      'better off dead', 'can\'t go on', 'ending it', 'take my life'
    ];
    
    // Emotional keywords for pattern matching
    this.emotionalKeywords = {
      sadness: ['sad', 'depressed', 'down', 'hopeless', 'empty', 'grief', 'loss'],
      anxiety: ['anxious', 'worried', 'panic', 'scared', 'nervous', 'overwhelmed'],
      loneliness: ['lonely', 'alone', 'isolated', 'disconnected', 'nobody cares'],
      anger: ['angry', 'mad', 'furious', 'rage', 'frustrated', 'irritated'],
      joy: ['happy', 'excited', 'joyful', 'great', 'amazing', 'wonderful']
    };
  }

  overrideChatFunctions() {
    // Monitor the main chat system and take over if it fails
    const originalFetch = window.fetch;
    let failureCount = 0;
    
    window.fetch = async function(...args) {
      try {
        const response = await originalFetch.apply(this, args);
        
        // If it's a chat request and it fails
        if (args[0] && args[0].includes('/index') && !response.ok) {
          failureCount++;
          if (failureCount >= 2) {
            console.log('🔄 Main chat system failing, activating emergency mode');
            window.emergencyCompanion.activateEmergencyMode();
          }
        }
        
        return response;
      } catch (error) {
        // Network error - activate emergency mode immediately
        if (args[0] && args[0].includes('/index')) {
          console.log('🚨 Network error detected, activating emergency mode');
          window.emergencyCompanion.activateEmergencyMode();
          throw error;
        }
        throw error;
      }
    };
  }

  monitorMainChatSystem() {
    // Check if main chat system exists and is working
    setInterval(() => {
      if (this.isEmergencyMode) return;
      
      // Look for error messages in the chat
      const errorMessages = document.querySelectorAll('.error-message, .message.error');
      if (errorMessages.length > 2) {
        console.log('🔄 Multiple errors detected, considering emergency mode');
      }
      
      // Check for network connectivity
      if (!navigator.onLine) {
        console.log('🌐 No internet connection, activating emergency mode');
        this.activateEmergencyMode();
      }
    }, 30000); // Check every 30 seconds
  }

  enableOfflineCompanion() {
    // Create emergency message handler
    window.emergencyCompanion.handleMessage = async (message) => {
      if (!message || !message.trim()) return null;
      
      try {
        const response = this.generateOfflineResponse(message);
        this.saveToLocalHistory(message, response);
        return {
          response: response,
          ai_name: this.aiName,
          mode: 'emergency',
          timestamp: new Date().toISOString()
        };
      } catch (error) {
        console.error('❌ Emergency response generation failed:', error);
        return {
          response: "I'm having some difficulty right now, but I'm still here with you. Please know that you're not alone.",
          ai_name: this.aiName,
          mode: 'emergency_fallback'
        };
      }
    };

    // Override sendMessage function if main chat class exists
    if (window.ZentrafugeChat || (typeof ZentrafugeChat !== 'undefined')) {
      console.log('🔄 Overriding main chat sendMessage function');
      this.overrideMainChatSendMessage();
    }
  }

  overrideMainChatSendMessage() {
    // Find the chat container
    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message');
    const sendButton = document.getElementById('send-button');
    
    if (!chatContainer || !messageInput || !sendButton) return;

    // Replace send button functionality
    const newSendButton = sendButton.cloneNode(true);
    sendButton.parentNode.replaceChild(newSendButton, sendButton);
    
    newSendButton.addEventListener('click', async (e) => {
      e.preventDefault();
      const message = messageInput.value.trim();
      if (!message) return;
      
      // Clear input
      messageInput.value = '';
      
      // Show user message
      this.displayMessage(message, 'user', chatContainer);
      
      // Generate AI response
      const response = await this.handleMessage(message);
      if (response) {
        this.displayMessage(response.response, 'cael', chatContainer);
      }
    });

    // Handle Enter key
    messageInput.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        newSendButton.click();
      }
    });
  }

  displayMessage(text, sender, container) {
    if (!container) {
      container = document.getElementById('chat-container');
      if (!container) return;
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const timestamp = new Date().toLocaleTimeString([], { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    messageDiv.innerHTML = `
      <div class="message-content">
        <div class="message-text">${this.formatMessageText(text)}</div>
        <div class="message-timestamp">${timestamp}</div>
        ${sender === 'cael' ? '<div class="emergency-badge">🛡️ Emergency Mode</div>' : ''}
      </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
    
    // Add emergency styling
    if (!document.getElementById('emergency-styles')) {
      const styles = document.createElement('style');
      styles.id = 'emergency-styles';
      styles.textContent = `
        .emergency-badge {
          font-size: 10px;
          color: #ff6b6b;
          margin-top: 4px;
          opacity: 0.7;
        }
        .message.cael-message.emergency {
          border-left: 3px solid #ff6b6b;
        }
      `;
      document.head.appendChild(styles);
    }
  }

  formatMessageText(text) {
    return text
      .replace(/\n/g, '<br>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>');
  }

  generateOfflineResponse(userMessage) {
    const message = userMessage.toLowerCase();
    
    // Crisis detection - highest priority
    if (this.detectCrisis(message)) {
      return this.getRandomResponse('crisis');
    }
    
    // Emotional pattern detection
    for (const [emotion, keywords] of Object.entries(this.emotionalKeywords)) {
      if (keywords.some(keyword => message.includes(keyword))) {
        return this.getRandomResponse(emotion);
      }
    }
    
    // Greeting detection
    if (message.includes('hello') || message.includes('hi') || message.includes('hey')) {
      return this.getRandomResponse('greeting');
    }
    
    // Default supportive response
    return this.getRandomResponse('general');
  }

  detectCrisis(message) {
    return this.crisisKeywords.some(keyword => message.includes(keyword));
  }

  getRandomResponse(category) {
    const responses = this.responsePatterns[category] || this.responsePatterns.general;
    const response = responses[Math.floor(Math.random() * responses.length)];
    
    // Personalize the response
    return response
      .replace(/\${this\.userName}/g, this.userName)
      .replace(/\${this\.aiName}/g, this.aiName);
  }

  saveToLocalHistory(userMessage, aiResponse) {
    const conversation = {
      timestamp: Date.now(),
      user: userMessage,
      ai: aiResponse,
      mode: this.isEmergencyMode ? 'emergency' : 'offline',
      aiName: this.aiName,
      userName: this.userName
    };
    
    this.conversationHistory.push(conversation);
    
    // Keep only last 100 conversations
    if (this.conversationHistory.length > 100) {
      this.conversationHistory = this.conversationHistory.slice(-100);
    }
    
    try {
      localStorage.setItem('zentrafuge_conversation_history', JSON.stringify(this.conversationHistory));
      
      // Also save user profile
      const profile = {
        name: this.userName,
        aiName: this.aiName,
        lastUpdate: Date.now()
      };
      localStorage.setItem('zentrafuge_user_profile', JSON.stringify(profile));
    } catch (error) {
      console.warn('⚠️ Could not save conversation to localStorage');
    }
  }

  // Public methods for integration
  isInEmergencyMode() {
    return this.isEmergencyMode || this.isOfflineMode;
  }

  getConversationHistory() {
    return this.conversationHistory;
  }

  exportData() {
    return {
      conversations: this.conversationHistory,
      profile: {
        userName: this.userName,
        aiName: this.aiName
      },
      exportDate: new Date().toISOString(),
      mode: 'emergency'
    };
  }
}

// Initialize the emergency companion system
console.log('🛡️ Loading emergency companion system...');
window.emergencyCompanion = new EmergencyCompanion();

// Add emergency features to the page
function addEmergencyFeatures() {
  // Add emergency export button if chat interface exists
  const chatContainer = document.getElementById('chat-container');
  if (chatContainer) {
    const exportBtn = document.createElement('button');
    exportBtn.innerHTML = '📥 Export Chat';
    exportBtn.style.cssText = `
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 9999;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0.8;
    `;
    
    exportBtn.onclick = () => {
      const data = window.emergencyCompanion.exportData();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `zentrafuge-emergency-backup-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };
    
    document.body.appendChild(exportBtn);
  }
  
  // Add emergency mode toggle (for testing)
  const emergencyToggle = document.createElement('button');
  emergencyToggle.innerHTML = '🛡️ Test Emergency';
  emergencyToggle.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 12px;
    opacity: 0.8;
  `;
  
  emergencyToggle.onclick = () => {
    if (!window.emergencyCompanion.isInEmergencyMode()) {
      window.emergencyCompanion.activateEmergencyMode();
      emergencyToggle.textContent = '✅ Emergency Active';
      emergencyToggle.style.background = '#4caf50';
    }
  };
  
  document.body.appendChild(emergencyToggle);
}

// Initialize emergency features when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', addEmergencyFeatures);
} else {
  addEmergencyFeatures();
}

console.log('✅ Emergency companion system ready - your users will never lose access!');
</script>
</body>
</html>
