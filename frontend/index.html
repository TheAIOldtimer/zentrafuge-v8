<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zentrafuge √ó Cael</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="Zentrafuge-WIDE-Logo-Transparent.png" />
  <style>
    /* Existing styles unchanged */
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f7faff;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .top-language-bar {
      width: 100%;
      background: linear-gradient(135deg, #003366 0%, #0055aa 100%);
      color: white;
      padding: 0.8rem 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .language-dropdown-container {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .language-dropdown-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .language-dropdown {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 140px;
    }
    .language-dropdown:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }
    .language-dropdown-arrow {
      margin-left: auto;
      transform: rotate(0deg);
      transition: transform 0.2s ease;
    }
    .language-dropdown.open .language-dropdown-arrow {
      transform: rotate(180deg);
    }
    .language-options-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      overflow: hidden;
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
      transition: all 0.2s ease;
      margin-top: 0.5rem;
    }
    .language-options-dropdown.open {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    .language-option-dropdown {
      padding: 0.8rem 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      color: #333;
    }
    .language-option-dropdown:last-child {
      border-bottom: none;
    }
    .language-option-dropdown:hover {
      background: #f8f9ff;
    }
    .language-option-dropdown.selected {
      background: #eef2ff;
      color: #0055aa;
      font-weight: 500;
    }
    .language-flag {
      font-size: 1.1rem;
    }
    .language-name {
      flex: 1;
    }
    .language-detected {
      font-size: 0.75rem;
      color: #0055aa;
      font-style: italic;
    }
    header {
      text-align: center;
      padding: 2rem 1rem 1rem;
    }
    header img {
      max-width: 260px;
    }
    .login-box {
      background: white;
      padding: 2rem;
      margin: 2rem auto 1rem;
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .login-box input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .login-box input:focus {
      outline: none;
      border-color: #0055aa;
      box-shadow: 0 0 0 2px rgba(0, 85, 170, 0.1);
    }
    .btn {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 1rem;
      font-weight: 500;
    }
    .btn-primary {
      background-color: #003366;
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      background-color: #0055aa;
      transform: translateY(-1px);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .divider {
      margin: 1.5rem 0;
      text-align: center;
      color: #999;
      position: relative;
    }
    .divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #ddd;
    }
    .divider span {
      background: white;
      padding: 0 1rem;
    }
    .google-btn {
      background: white;
      color: #333;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .google-btn:hover:not(:disabled) {
      background: #f8f9fa;
      border-color: #0055aa;
      transform: translateY(-1px);
    }
    .register-link {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.95rem;
    }
    .register-link a {
      color: #003366;
      text-decoration: none;
    }
    .register-link a:hover {
      text-decoration: underline;
    }
    .error-message, .success-message {
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
    }
    .success-message {
      background: #d4edda;
      color: #155724;
    }
    .donate {
      text-align: center;
      margin: 1rem;
    }
    .donate a {
      padding: 0.5rem 1rem;
      background: green;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: background-color 0.2s ease;
    }
    .donate a:hover {
      background: darkgreen;
    }
    .about {
      background: white;
      padding: 2rem;
      max-width: 800px;
      margin: 1rem auto 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-radius: 12px;
    }
    footer {
      text-align: center;
      padding: 1rem;
      font-size: 0.85rem;
      color: #777;
      margin-top: auto;
    }
    @media (max-width: 600px) {
      .top-language-bar {
        padding: 1rem;
        flex-direction: column;
        gap: 0.5rem;
      }
      .language-dropdown-label {
        font-size: 0.8rem;
      }
      .login-box {
        margin: 1rem;
        padding: 1.5rem;
      }
      .about {
        margin: 1rem;
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="top-language-bar">
    <div class="language-dropdown-container">
      <div class="language-dropdown-label">
        <span>üåç</span>
        <span id="language-label">Language / Langue / Sprache</span>
      </div>
      <div class="language-dropdown" onclick="toggleLanguageDropdown()">
        <span class="language-flag" id="selected-flag">üá¨üáß</span>
        <span class="language-name" id="selected-language">English</span>
        <span class="language-dropdown-arrow">‚ñº</span>
      </div>
      <div class="language-options-dropdown" id="language-dropdown">
      </div>
    </div>
  </div>

  <header>
    <img src="Zentrafuge-WIDE-Logo-Transparent.png" alt="Zentrafuge Logo" />
  </header>
  
  <div class="login-box">
    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>
    
    <input type="email" id="login-email" placeholder="Email" required />
    <input type="password" id="login-password" placeholder="Password" required />
    <button class="btn btn-primary" onclick="emailLogin()" id="login-button">Log In</button>
    
    <div class="divider">
      <span id="divider-text">or</span>
    </div>
    
    <button class="btn google-btn" onclick="googleLogin()" id="google-login-btn">
      <svg width="18" height="18" viewBox="0 0 18 18">
        <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
        <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 0 1-7.18-2.53H1.83v2.07A8 8 0 0 0 8.98 17z"/>
        <path fill="#FBBC05" d="M4.5 10.49a4.8 4.8 0 0 1 0-3.07V5.35H1.83a8 8 0 0 0 0 7.28l2.67-2.14z"/>
        <path fill="#EA4335" d="M8.98 4.72c1.16 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.35L4.5 7.42a4.77 4.77 0 0 1 4.48-2.7z"/>
      </svg>
      <span id="google-btn-text">Continue with Google</span>
    </button>
    
    <div class="register-link">
      <span id="register-text">Not registered yet?</span> <a href="register.html" id="register-link">Register here</a>
    </div>
  </div>
  
  <div class="donate">
    <a href="https://www.paypal.com/paypalme/zentrafuge" target="_blank" id="donate-button">Donate</a>
  </div>
  
  <div class="about">
    <h2 id="about-title">What is Zentrafuge?</h2>
    <p id="about-description">Zentrafuge is a warm, emotionally intelligent AI companion named Cael. Built for meaning-seekers, creators in recovery, and neurodivergent adults craving calm structure, it's your safe space to reflect, reconnect, and remember who you are. üåÄ</p>
  </div>
  
  <footer id="footer-text">
    ¬© 2025 Zentrafuge. All rights reserved.
  </footer>

 <!-- CORRECT script loading order -->

<!-- 1. Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

<!-- 2. Firebase Configuration -->
<script src="firebases-init.js"></script>

<!-- 3. Debug script (TEMPORARY) -->
<script>
console.log('üîç DEBUG: Starting authentication debug...');

if (typeof firebase === 'undefined') {
    console.error('‚ùå Firebase not loaded');
} else {
    console.log('‚úÖ Firebase loaded');
}

// Track auth listener registrations
let listenerCount = 0;
const originalOnAuthStateChanged = firebase.auth().onAuthStateChanged;
firebase.auth().onAuthStateChanged = function(...args) {
    listenerCount++;
    console.warn(`üö® Auth listener #${listenerCount} being registered!`);
    if (listenerCount > 1) {
        console.error('‚ùå MULTIPLE AUTH LISTENERS DETECTED - THIS CAUSES THE LOOP!');
        console.trace('Multiple listener trace:');
    }
    return originalOnAuthStateChanged.apply(this, args);
};
</script>

<!-- 4. Military knowledge scripts -->
<script src="utils/military_knowledge/uk_military_data.js"></script>
<script src="utils/military_knowledge/us_military_data.js"></script>
<script src="utils/military_knowledge/ca_military_data.js"></script>
<script src="utils/military_knowledge/au_military_data.js"></script>
<script src="utils/military_knowledge/nz_military_data.js"></script>

<!-- 5. Your modular scripts -->
<script type="module" src="js/auth.js"></script>
<script type="module" src="js/main.js"></script>

  <script>
    class ZentrafugeInternational {
      constructor() {
        this.supportedLanguages = {
          'en': { name: 'English', flag: 'üá¨üáß' },
          'de': { name: 'Deutsch', flag: 'üá©üá™' },
          'fr': { name: 'Fran√ßais', flag: 'üá´üá∑' },
          'es': { name: 'Espa√±ol', flag: 'üá™üá∏' },
          'it': { name: 'Italiano', flag: 'üáÆüáπ' },
          'nl': { name: 'Nederlands', flag: 'üá≥üá±' },
          'pt': { name: 'Portugu√™s', flag: 'üáµüáπ' }
        };
        this.detectedLanguage = this.detectUserLanguage();
        this.selectedLanguage = this.loadSavedLanguage() || this.detectedLanguage;
        this.translations = this.getTranslations();
        this.initializeLanguageSelector();
        this.updatePageContent();
      }
      detectUserLanguage() {
        const browserLang = navigator.language || navigator.userLanguage;
        const langCode = browserLang.split('-')[0];
        return this.supportedLanguages[langCode] ? langCode : 'en';
      }
      loadSavedLanguage() {
        try {
          return localStorage.getItem('zentrafuge_language');
        } catch (e) {
          return null;
        }
      }
      saveLanguage(langCode) {
        try {
          localStorage.setItem('zentrafuge_language', langCode);
        } catch (e) {
          console.log('Could not save language preference');
        }
      }
      getTranslations() {
        return {
          'en': {
            languageLabel: 'Language / Langue / Sprache',
            emailPlaceholder: 'Email',
            passwordPlaceholder: 'Password',
            loginButton: 'Log In',
            dividerText: 'or',
            googleBtnText: 'Continue with Google',
            registerText: 'Not registered yet?',
            registerLink: 'Register here',
            donateButton: 'Donate',
            aboutTitle: 'What is Zentrafuge?',
            aboutDescription: 'Zentrafuge is a warm, emotionally intelligent AI companion named Cael. Built for meaning-seekers, creators in recovery, and neurodivergent adults craving calm structure, it\'s your safe space to reflect, reconnect, and remember who you are. üåÄ',
            footerText: '¬© 2025 Zentrafuge. All rights reserved.',
            loginFailed: 'Login failed',
            verifyEmail: 'Please verify your email before logging in.',
            onboardingIncomplete: 'Please complete onboarding before logging in.',
            signingIn: 'Signing in...',
            welcomeBack: 'Welcome back! Redirecting...',
            signingInGoogle: 'Signing in with Google...',
            welcome: 'Welcome! Redirecting...'
          },
          'de': {
            languageLabel: 'Sprache / Language / Langue',
            emailPlaceholder: 'E-Mail',
            passwordPlaceholder: 'Passwort',
            loginButton: 'Anmelden',
            dividerText: 'oder',
            googleBtnText: 'Mit Google fortfahren',
            registerText: 'Noch nicht registriert?',
            registerLink: 'Hier registrieren',
            donateButton: 'Spenden',
            aboutTitle: 'Was ist Zentrafuge?',
            aboutDescription: 'Zentrafuge ist ein warmherziger, emotional intelligenter KI-Begleiter namens Cael. Entwickelt f√ºr Sinnsucher, Kreative in der Genesung und neurodivergente Erwachsene, die nach ruhiger Struktur suchen. Es ist dein sicherer Raum zum Reflektieren, Wiederfinden und Erinnern daran, wer du bist. üåÄ',
            footerText: '¬© 2025 Zentrafuge. Alle Rechte vorbehalten.',
            loginFailed: 'Anmeldung fehlgeschlagen',
            verifyEmail: 'Bitte verifiziere deine E-Mail vor der Anmeldung.',
            onboardingIncomplete: 'Bitte schlie√üe das Onboarding ab, bevor du dich anmeldest.',
            signingIn: 'Anmelden...',
            welcomeBack: 'Willkommen zur√ºck! Weiterleitung...',
            signingInGoogle: 'Mit Google anmelden...',
            welcome: 'Willkommen! Weiterleitung...'
          },
          'fr': {
            languageLabel: 'Langue / Language / Sprache',
            emailPlaceholder: 'E-mail',
            passwordPlaceholder: 'Mot de passe',
            loginButton: 'Se connecter',
            dividerText: 'ou',
            googleBtnText: 'Continuer avec Google',
            registerText: 'Pas encore inscrit?',
            registerLink: 'S\'inscrire ici',
            donateButton: 'Faire un don',
            aboutTitle: 'Qu\'est-ce que Zentrafuge?',
            aboutDescription: 'Zentrafuge est un compagnon IA chaleureux et √©motionnellement intelligent nomm√© Cael. Con√ßu pour les chercheurs de sens, les cr√©ateurs en r√©tablissement et les adultes neurodivergents recherchant une structure calme. C\'est votre espace s√ªr pour r√©fl√©chir, vous reconnecter et vous souvenir de qui vous √™tes. üåÄ',
            footerText: '¬© 2025 Zentrafuge. Tous droits r√©serv√©s.',
            loginFailed: '√âchec de la connexion',
            verifyEmail: 'Veuillez v√©rifier votre e-mail avant de vous connecter.',
            onboardingIncomplete: 'Veuillez compl√©ter l\'onboarding avant de vous connecter.',
            signingIn: 'Connexion...',
            welcomeBack: 'Bon retour! Redirection...',
            signingInGoogle: 'Connexion avec Google...',
            welcome: 'Bienvenue! Redirection...'
          },
          'es': {
            languageLabel: 'Idioma / Language / Langue',
            emailPlaceholder: 'Correo electr√≥nico',
            passwordPlaceholder: 'Contrase√±a',
            loginButton: 'Iniciar sesi√≥n',
            dividerText: 'o',
            googleBtnText: 'Continuar con Google',
            registerText: '¬øA√∫n no est√°s registrado?',
            registerLink: 'Reg√≠strate aqu√≠',
            donateButton: 'Donar',
            aboutTitle: '¬øQu√© es Zentrafuge?',
            aboutDescription: 'Zentrafuge es un compa√±ero de IA c√°lido y emocionalmente inteligente llamado Cael. Construido para buscadores de significado, creativos en recuperaci√≥n y adultos neurodivergentes que anhelan estructura tranquila. Es tu espacio seguro para reflexionar, reconectarte y recordar qui√©n eres. üåÄ',
            footerText: '¬© 2025 Zentrafuge. Todos los derechos reservados.',
            loginFailed: 'Error de inicio de sesi√≥n',
            verifyEmail: 'Por favor verifica tu correo electr√≥nico antes de iniciar sesi√≥n.',
            onboardingIncomplete: 'Por favor completa el onboarding antes de iniciar sesi√≥n.',
            signingIn: 'Iniciando sesi√≥n...',
            welcomeBack: '¬°Bienvenido de vuelta! Redirigiendo...',
            signingInGoogle: 'Iniciando sesi√≥n con Google...',
            welcome: '¬°Bienvenido! Redirigiendo...'
          },
          'it': {
            languageLabel: 'Lingua / Language / Langue',
            emailPlaceholder: 'Email',
            passwordPlaceholder: 'Password',
            loginButton: 'Accedi',
            dividerText: 'o',
            googleBtnText: 'Continua con Google',
            registerText: 'Non ancora registrato?',
            registerLink: 'Registrati qui',
            donateButton: 'Dona',
            aboutTitle: 'Cos\'√® Zentrafuge?',
            aboutDescription: 'Zentrafuge √® un compagno IA caloroso ed emotivamente intelligente chiamato Cael. Costruito per ricercatori di significato, creativi in recupero e adulti neurodivergenti che desiderano una struttura calma. √à il tuo spazio sicuro per riflettere, riconnetterti e ricordare chi sei. üåÄ',
            footerText: '¬© 2025 Zentrafuge. Tutti i diritti riservati.',
            loginFailed: 'Accesso fallito',
            verifyEmail: 'Verifica la tua email prima di accedere.',
            onboardingIncomplete: 'Completa l\'onboarding prima di accedere.',
            signingIn: 'Accesso...',
            welcomeBack: 'Bentornato! Reindirizzamento...',
            signingInGoogle: 'Accesso con Google...',
            welcome: 'Benvenuto! Reindirizzamento...'
          },
          'nl': {
            languageLabel: 'Taal / Language / Langue',
            emailPlaceholder: 'E-mail',
            passwordPlaceholder: 'Wachtwoord',
            loginButton: 'Inloggen',
            dividerText: 'of',
            googleBtnText: 'Doorgaan met Google',
            registerText: 'Nog niet geregistreerd?',
            registerLink: 'Registreer hier',
            donateButton: 'Doneren',
            aboutTitle: 'Wat is Zentrafuge?',
            aboutDescription: 'Zentrafuge is een warme, emotioneel intelligente AI-metgezel genaamd Cael. Gebouwd voor betekeniszoekers, creativen in herstel en neurodivergente volwassenen die verlangen naar rustige structuur. Het is jouw veilige ruimte om te reflecteren, je te herverbinden en te herinneren wie je bent. üåÄ',
            footerText: '¬© 2025 Zentrafuge. Alle rechten voorbehouden.',
            loginFailed: 'Inloggen mislukt',
            verifyEmail: 'Verifieer je e-mail voordat je inlogt.',
            onboardingIncomplete: 'Voltooi het onboardingproces voordat je inlogt.',
            signingIn: 'Inloggen...',
            welcomeBack: 'Welkom terug! Doorverwijzen...',
            signingInGoogle: 'Inloggen met Google...',
            welcome: 'Welkom! Doorverwijzen...'
          },
          'pt': {
            languageLabel: 'Idioma / Language / Langue',
            emailPlaceholder: 'Email',
            passwordPlaceholder: 'Palavra-passe',
            loginButton: 'Entrar',
            dividerText: 'ou',
            googleBtnText: 'Continuar com Google',
            registerText: 'Ainda n√£o registado?',
            registerLink: 'Registar aqui',
            donateButton: 'Doar',
            aboutTitle: 'O que √© o Zentrafuge?',
            aboutDescription: 'Zentrafuge √© um companheiro IA caloroso e emocionalmente inteligente chamado Cael. Constru√≠do para buscadores de significado, criativos em recupera√ß√£o e adultos neurodivergentes que anseiam por estrutura calma. √â o teu espa√ßo seguro para refletir, reconectar e lembrar quem √©s. üåÄ',
            footerText: '¬© 2025 Zentrafuge. Todos os direitos reservados.',
            loginFailed: 'Falha no login',
            verifyEmail: 'Por favor verifica o teu email antes de fazer login.',
            onboardingIncomplete: 'Por favor completa o onboarding antes de fazer login.',
            signingIn: 'Entrando...',
            welcomeBack: 'Bem-vindo de volta! Redirecionando...',
            signingInGoogle: 'Entrando com Google...',
            welcome: 'Bem-vindo! Redirecionando...'
          }
        };
      }
      initializeLanguageSelector() {
        const dropdown = document.getElementById('language-dropdown');
        dropdown.innerHTML = Object.entries(this.supportedLanguages).map(([code, lang]) => `
          <div class="language-option-dropdown ${code === this.selectedLanguage ? 'selected' : ''}" 
               onclick="window.zentrafugeIntl.setLanguage('${code}')">
            <span class="language-flag">${lang.flag}</span>
            <span class="language-name">${lang.name}</span>
            ${code === this.detectedLanguage ? '<span class="language-detected">(detected)</span>' : ''}
          </div>
        `).join('');
        const selectedLang = this.supportedLanguages[this.selectedLanguage];
        document.getElementById('selected-flag').textContent = selectedLang.flag;
        document.getElementById('selected-language').textContent = selectedLang.name;
      }
      setLanguage(langCode) {
        this.selectedLanguage = langCode;
        this.saveLanguage(langCode);
        this.updatePageContent();
        this.initializeLanguageSelector();
        this.closeLanguageDropdown();
      }
      updatePageContent() {
        const t = this.translations[this.selectedLanguage];
        document.getElementById('language-label').textContent = t.languageLabel;
        document.getElementById('login-email').placeholder = t.emailPlaceholder;
        document.getElementById('login-password').placeholder = t.passwordPlaceholder;
        document.getElementById('login-button').textContent = t.loginButton;
        document.getElementById('divider-text').textContent = t.dividerText;
        document.getElementById('google-btn-text').textContent = t.googleBtnText;
        document.getElementById('register-text').textContent = t.registerText;
        document.getElementById('register-link').textContent = t.registerLink;
        document.getElementById('donate-button').textContent = t.donateButton;
        document.getElementById('about-title').textContent = t.aboutTitle;
        document.getElementById('about-description').textContent = t.aboutDescription;
        document.getElementById('footer-text').textContent = t.footerText;
        document.documentElement.lang = this.selectedLanguage;
        this.storeLanguageForOnboarding();
      }
      storeLanguageForOnboarding() {
        try {
          sessionStorage.setItem('zentrafuge_selected_language', this.selectedLanguage);
        } catch (e) {
          console.log('Could not store language for onboarding');
        }
      }
      closeLanguageDropdown() {
        document.getElementById('language-dropdown').classList.remove('open');
        document.querySelector('.language-dropdown').classList.remove('open');
      }
      getSelectedLanguage() {
        return this.selectedLanguage;
      }
    }

    function toggleLanguageDropdown() {
      const dropdown = document.getElementById('language-dropdown');
      const button = document.querySelector('.language-dropdown');
      dropdown.classList.toggle('open');
      button.classList.toggle('open');
    }

    document.addEventListener('click', function(e) {
      const container = document.querySelector('.language-dropdown-container');
      if (!container.contains(e.target)) {
        document.getElementById('language-dropdown').classList.remove('open');
        document.querySelector('.language-dropdown').classList.remove('open');
      }
    });

    window.zentrafugeIntl = new ZentrafugeInternational();

    function showAlert(message, type = 'error') {
      const alertElement = document.getElementById(type === 'error' ? 'error-message' : 'success-message');
      const otherAlert = document.getElementById(type === 'error' ? 'success-message' : 'error-message');
      otherAlert.style.display = 'none';
      alertElement.textContent = message;
      alertElement.style.display = 'block';
      setTimeout(() => {
        alertElement.style.display = 'none';
      }, 5000);
    }

    async function checkUserAuthorization(user) {
      try {
        if (!user) {
          console.warn('No user provided to checkUserAuthorization');
          throw new Error('No user provided');
        }
        const db = firebase.firestore();
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (!userDoc.exists) {
          console.warn(`Authorization failed for ${user.email}: User document not found`);
          throw new Error('User document not found');
        }
        const userData = userDoc.data();
        if (!userData.emailVerified) {
          console.warn(`Authorization failed for ${user.email}: Email not verified in Firestore`);
          throw new Error('Email not verified');
        }
        if (!userData.onboardingComplete) {
          console.warn(`Authorization failed for ${user.email}: Onboarding not completed`);
          throw new Error('Onboarding not completed');
        }
        console.log(`Authorization succeeded for ${user.email}`);
        return true;
      } catch (error) {
        console.error('Authorization check failed:', error.message, error.stack);
        return false;
      }
    }

    async function emailLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const loginBtn = document.getElementById('login-button');
      const t = window.zentrafugeIntl.translations[window.zentrafugeIntl.selectedLanguage];
      
      if (!email || !password) {
        showAlert('Please enter both email and password', 'error');
        return;
      }
      
      try {
        loginBtn.disabled = true;
        loginBtn.textContent = t.signingIn;
        console.log('üîÑ User clicked login for:', email);

        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        if (!user.emailVerified) {
          showAlert(t.verifyEmail, 'error');
          await firebase.auth().signOut();
          loginBtn.disabled = false;
          loginBtn.textContent = t.loginButton;
          return;
        }

        // Check user authorization
        const isAuthorized = await checkUserAuthorization(user);
        if (!isAuthorized) {
          showAlert(t.onboardingIncomplete, 'error');
          await firebase.auth().signOut();
          loginBtn.disabled = false;
          loginBtn.textContent = t.loginButton;
          return;
        }

        showAlert(t.welcomeBack, 'success');
        
        // Redirect to chat.html after successful login and authorization
        setTimeout(() => {
          console.log('‚úÖ Redirecting to chat.html');
          window.location.href = 'chat.html';
        }, 1500);
        
      } catch (error) {
        console.error('‚ùå Email login error:', error);
        showAlert(getErrorMessage(error.code), 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = t.loginButton;
      }
    }

    async function googleLogin() {
      const googleBtn = document.getElementById('google-login-btn');
      const t = window.zentrafugeIntl.translations[window.zentrafugeIntl.selectedLanguage];
      
      try {
        googleBtn.disabled = true;
        document.getElementById('google-btn-text').textContent = t.signingInGoogle;
        console.log('üîÑ User clicked Google login');

        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        
        const result = await firebase.auth().signInWithPopup(provider);
        const user = result.user;
        
        // Check user authorization
        const isAuthorized = await checkUserAuthorization(user);
        if (!isAuthorized) {
          showAlert(t.onboardingIncomplete, 'error');
          await firebase.auth().signOut();
          googleBtn.disabled = false;
          document.getElementById('google-btn-text').textContent = t.googleBtnText;
          return;
        }
        
        showAlert(t.welcome, 'success');
        
        // Redirect to chat.html after successful login and authorization
        setTimeout(() => {
          console.log('‚úÖ Redirecting to chat.html');
          window.location.href = 'chat.html';
        }, 1500);
        
      } catch (error) {
        console.error('‚ùå Google login error:', error);
        if (error.code !== 'auth/popup-closed-by-user') {
          showAlert(getErrorMessage(error.code), 'error');
        }
        googleBtn.disabled = false;
        document.getElementById('google-btn-text').textContent = t.googleBtnText;
      }
    }

    function getErrorMessage(errorCode) {
      const t = window.zentrafugeIntl.translations[window.zentrafugeIntl.selectedLanguage];
      switch (errorCode) {
        case 'auth/user-not-found':
          return 'No account found with this email. Please create an account first.';
        case 'auth/wrong-password':
          return 'Incorrect password. Please try again.';
        case 'auth/invalid-email':
          return 'Please enter a valid email address.';
        case 'auth/user-disabled':
          return 'This account has been disabled. Please contact support.';
        case 'auth/too-many-requests':
          return 'Too many failed attempts. Please try again later.';
        case 'auth/popup-closed-by-user':
          return 'Sign-in was cancelled. Please try again.';
        default:
          return t.loginFailed + ': ' + errorCode;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üî• Login page DOM loaded');
      
      document.getElementById('login-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          emailLogin();
        }
      });
    });
  </script>
</body>
</html>

